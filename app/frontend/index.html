<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tipper test page</title>
  </head>
  <body>
    <h1>Tipper test page.</h1>
    <h3>Click the button below to submit a tip report to the server</h3>
    <p id="message"></p>
    <button id="create-report" type="submit">
      Create tip report
    </button>
	<script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var tipButton = document.getElementById("create-report");
      var message = document.getElementById("message");
      tipButton.addEventListener("click", function(e) {
        e.preventDefault();
        message.innerText = "";
        tipButton.setAttribute("disabled", "");
        tipButton.innerText = "Determining location...";
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(function(position) {
            tipButton.innerText = "Position determined. Creating report..."

            console.log("Got position", position.coords.latitude, position.coords.longitude);
            var reportContent = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
            }

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/reports/", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onreadystatechange = function() {
              if (this.readyState === XMLHttpRequest.DONE) {
                if (this.status === 200) {
                  var response = JSON.parse(xhr.responseText);
                  message.innerText = "Tip report with id " + response.id + " created successfully (" + response.latitude + ", " + response.longitude + ")";
                }
                else {
                  console.error("Call to the backend failed");
                  message.innerText = "Failed to create tip report";
                }
                tipButton.innerText = "Create another tip report";
                tipButton.removeAttribute("disabled");
              }
            }

            xhr.send(JSON.stringify(reportContent));
          });
        }
        else {
          console.error("Geo location is not available. Bailing.")
        }

      });
    });
  </script>
  </body>
</html>
